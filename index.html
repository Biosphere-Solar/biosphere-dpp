<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biosphere Solar — Digital Product Passport</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@800&family=Exo+2:wght@300;600&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
       /* DARK (default) */
      --brand:#00d18f; --brand-2:#6f7dff;
      --bg1:#0b0e1a; --bg2:#14213d; --card:#0f1326; --line:#20274a; --muted:#9aa3b2; --text:#e5e9f0;
    }
    
    :root[data-theme="light"]{
      --brand:#166534; --brand-2:#1d4ed8;
      --bg1:#f7fafc; --bg2:#eef2f7;
      --card:#ffffff; --line:#e2e8f0;
      --muted:#475569; --text:#0f172a;
    }

    /* Font stacks */
    :root{
      --font-title: "Source Code Pro", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --font-head:  "Exo 2", system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-body:  "PT Sans", system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    /* Body defaults */
    body{ font-family: var(--font-body); }
    
    /* Titles (big hero h1 etc.) */
    h1, .title, .title-brand{
      font-family: var(--font-title);
      font-weight: 800;            /* ExtraBold */
      letter-spacing: .01em;
    }
    
    /* Section headers */
    h2, h3, .card h3{
      font-family: var(--font-head);
      font-weight: 600;            /* SemiBold */
    }
    
    /* Subheaders (taglines, small section intros) */
    .subhead, .hero p{
      font-family: var(--font-head);
      font-weight: 300;            /* Light */
    }
    
    /* Chips / badges / small subtitles = Source Code Pro ALL CAPS */
    .pill, .badge, .tag{
      font-family: var(--font-title);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 11.5px;           /* tweak to taste */
      line-height: 1;              /* keeps the bubble tight */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }
    
    /* Numbers can look great in mono too */
    .stat .k{
      font-family: var(--font-title);
      font-weight: 800;
      letter-spacing: .02em;
    }
    
    /* Responsive sizing still using clamp */
    .hero h1{ font-size: clamp(34px, 4.6vw, 56px); }

    /* Body defaults – keep only this body rule */
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--text);
      font-family: var(--font-body);
      background:
        radial-gradient(1200px 600px at 20% -10%, #1b2757 0%, transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, #1a3b2e 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    a{color:#9cc7ff}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px 56px}
    .hero{display:grid; grid-template-columns: 1.1fr .9fr; gap:36px; align-items:center}
    .hero h1{font-size:48px; line-height:1.05; margin:0 0 12px}
    .hero p{color:var(--muted); font-size:18px; margin:0 0 18px}
    .cta{display:flex; gap:12px; flex-wrap:wrap}
    .btn{background:var(--brand); color:#05110e; padding:12px 16px; border-radius:12px; font-weight:700; text-decoration:none; box-shadow:0 8px 24px rgba(0,209,143,.25)}
    .btn.outline{background:transparent; color:#bcd7ff; border:1px solid #33406b}

    .phone{position:relative; border-radius:32px; background:linear-gradient(180deg,#0f1224,#0a0d1b); border:1px solid #1f2546; box-shadow:0 12px 30px rgba(0,0,0,.35); padding:18px; min-height:560px}
    .pill{display:inline-block; font-size:12px; color:#a8b2c8; border:1px solid #24305d; border-radius:999px; padding:4px 10px;}
    .pill.active{background:#1a2346; border-color:#3a4aa0; color:#dfe7ff}
    .phone .title{font-weight:800; font-size:22px;}
    .phone .card{background:#0c1020; border:1px solid #1b2250; border-radius:16px; padding:12px; margin-top:10px}


    /* size scales automatically: ~18px on phones up to 30px on desktop */
    :root{ --logo-size: clamp(18px, 6vw, 30px); }
    
    /* brand pill */
    .pill-brand{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(8,12,28,.5);
    }
    
    /* logo image */
    .brand-logo{
      height: var(--logo-size);
      width: auto;
      display: block;                 /* avoids baseline misalignment */
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.35));
    }
    
    /* “DPP” text */
    .pill-brand .brand-abbrev{
      font-family: var(--font-title);
      font-weight: 800;
      letter-spacing: .10em;
      font-size: 14px;
      line-height: 1;
      text-transform: uppercase;
    }
    
    /* lighten a touch in light mode */
    :root[data-theme="light"] .pill-brand{
      background: rgba(15,23,42,.08);
    }



    .grid{display:grid; grid-template-columns:2fr 1fr; gap:24px; margin-top:26px}
    .card{background:rgba(8,12,28,.7); border:1px solid var(--line); border-radius:18px; padding:18px; backdrop-filter: blur(6px);}
    .card h3{margin:0 0 10px; font-size:16px; color:#dce3f1; letter-spacing:.2px}

    table{width:100%; border-collapse:collapse;}
    th,td{border-bottom:1px dashed #263057; padding:10px 6px; text-align:left; vertical-align:top}
    th{color:#9fb1d9; font-weight:600; width:38%}
    td{color:#e8ecf7}

    .row{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:14px}
    .stat{padding:14px; background:#0c1022; border:1px solid #1b2250; border-radius:14px}
    .stat .k{font-size:22px; font-weight:800}
    .muted{color:var(--muted)}
    .badge{background:#0e1531; border:1px solid #283264; padding:6px 9px; border-radius:999px; color:#a7b6e2; font-size:12px}

    /* === Hero spacing overrides === */
    .wrap{ padding: 16px 20px 40px; }                 /* move everything up a bit */
    .hero{ gap: 20px; align-items: flex-start; }      /* tighter gap; top-align vs center */
    .hero > div:first-child{ max-width: 56ch; }       /* nicer line length for text */
    
    .hero h1{
      margin: 0 0 6px;   /* space below the heading */
      line-height: 1.05; /* keep it punchy */
    }
    .hero p{
      margin: 4px 0 12px;  /* space above/below paragraph */
      font-size: 17px;     /* optional: slightly smaller */
    }

    /* Optional: make the whole hero sit closer to the top */
    section.hero{ margin-top: -6px; }  /* use positive value if you want more gap */

    /* Mobile tuning */
    @media (max-width: 960px){
      .wrap{ padding: 14px 16px 36px; }
      .hero{ gap: 16px; }
      .hero h1{ font-size: 36px; margin-bottom: 8px; }
      .hero p{ margin-bottom: 10px; }
    }
    /* two-column layout */
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:24px; }
    
    /* right column stacks its cards tightly */
    .rightcol{ display:grid; gap:18px; align-content:start; }
    
    /* mobile: single column */
    @media (max-width: 960px){
      .grid{ grid-template-columns:1fr; }
    }


    /* Circularity bars */
    .bars{display:grid;gap:10px;margin-top:10px}
    .bar{background:#0d1228;border:1px solid #2a356a;border-radius:10px;overflow:hidden;height:12px}
    .bar .fill{height:100%;background:linear-gradient(90deg,#00d18f,#6f7dff);}

    /* Explorer */
    .accordion h4{margin:14px 0 6px; color:#dce3f1}
    .accordion details{border:1px solid #263057; border-radius:10px; background:#0d1228; padding:8px 10px; margin-bottom:8px}
    .accordion summary{cursor:pointer; list-style:none}
    .tabs{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .select{background:#0d1228;color:#eaf2ff;border:1px solid #2a356a;border-radius:10px;padding:8px 12px}
    @media (max-width: 960px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .phone{min-height:auto}
    }
    /* === Type scale overrides === */
    .hero h1{
      font-size: clamp(36px, 5vw, 56px);  /* smaller on phones, big on desktop */
      line-height: 1.05;
      margin: 0 0 8px;
    }
    .hero p{
      font-size: clamp(15px, 1.6vw, 18px);
      margin: 4px 0 14px;
    }
    .card h3{
      font-size: 15px; /* section titles */
      letter-spacing: .2px;
    }
    .stat .k{
      font-size: clamp(20px, 2.4vw, 28px); /* KPI numbers on the phone card */
    }
    table, td, th{
      font-size: 14.5px;
    }
    .theme-toggle{
      position: fixed;
      top: 16px;          /* change to bottom:16px for bottom-right */
      right: 16px;
      z-index: 1000;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      cursor: pointer;
    }
    .theme-toggle:hover{ filter: brightness(1.1); }

    /* Boolean badges for chemical presence */
    :root{ --ok-bg:#112217; --ok-fg:#22c55e; --bad-bg:#2a1114; --bad-fg:#ef4444; }
    :root[data-theme="light"]{ --ok-bg:#e8f7ee; --ok-fg:#166534; --bad-bg:#fde8ea; --bad-fg:#991b1b; }
    
    .tag{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line) }
    .tag.yes{ background:var(--bad-bg); color:var(--bad-fg); border-color: color-mix(in oklab, var(--bad-fg) 30%, transparent) }
    .tag.no { background:var(--ok-bg);  color:var(--ok-fg);  border-color: color-mix(in oklab, var(--ok-fg) 30%, transparent) }

    /* Hide auto-inserted category headings inside the extra section */
    #extraCats > h4 { display: none; }

    /* Keep extra cards in the right column without touching Passport Info */
    .rightcol-item { grid-column: 2; }
    @media (max-width:960px){ .rightcol-item { grid-column: auto; } }

    /* Limit the doughnut size on desktop and mobile */
    .chartBox{
      position: relative;
      width: 100%;
      max-width: 520px;   /* cap width on large screens */
      height: 360px;      /* controls the donut diameter */
      margin: 0 auto;     /* center in the card */
    }
    
    /* Smaller chart on narrow screens */
    @media (max-width: 960px){
      .chartBox{ max-width: 100%; height: 260px; }
    }

    /* prevent surprise horizontal scroll */
    html, body { max-width: 100%; overflow-x: hidden; }
    
    /* make the toolbar stack on phones */
    .toolbar{
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 8px 0 12px;
    }
    @media (max-width: 600px){
      .toolbar{ flex-direction: column; align-items: stretch; gap: 6px; }
    }
    
    /* selects shouldn’t force width */
    .select{ width: 100%; max-width: 100%; }
    
    /* tabs: allow wrapping on small screens (or keep overflow:auto if you prefer) */
    @media (max-width: 600px){
      .tabs{ flex-wrap: wrap; }
    }
    
    /* tables inside explorers: wrap long content, don’t blow out width */
    #specExplorer table, #mechExplorer table{
      width: 100%;
      table-layout: fixed;     /* makes wrapping predictable */
    }
    #specExplorer th, #specExplorer td,
    #mechExplorer th, #mechExplorer td{
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    
    /* make sure small chips don’t force width */
    .pill, .badge, .tag{ min-width: 0; }

    /* Center text perfectly inside the pill */
    .badge{
      display: inline-flex;
      align-items: center;        /* vertical center */
      justify-content: center;    /* horizontal center */
      padding: 8px 12px;          /* tweak as you like */
      border-radius: 999px;
      line-height: 1;             /* remove extra leading from the font */
      white-space: nowrap;        /* avoid wrapping the serial */
    }


  </style>
</head>
<body>
  <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">🌗</button>
  <div class="wrap">
    <section class="hero">
      <div>
        <h1>Digital Product Passport - ESPR compliance</h1>
        <p>The EU Ecodesign for Sustainable Products Regulation (ESPR) requires transparent, durable, repairable products. Biosphere’s DPP shares verified specs, circularity metrics, and end-of-life guidance per panel.</p>
        <div class="cta">
          <a id="openDatasheet" class="btn" href="#" target="_blank" rel="noopener">Open datasheet</a>
          <a class="btn outline" href="#materials">View materials</a>
          <span id="serialBadge" class="badge">Serial: —</span>
        </div>
      </div>

      <div class="phone">
        <!-- inside your .cta or header -->
        <div class="pill pill-brand">
          <img
            src="./assets/biosphere-logo-white.png"
            alt="Biosphere Solar"
            class="brand-logo"
            onerror="this.remove()" />
          <span class="brand-abbrev">DPP</span>
        </div>

        <div class="title" style="margin:8px 0 6px" id="modelTitle">—</div>
        <div class="muted" id="countryYear">—</div>

        <div class="row" style="margin-top:14px">
          <div class="stat"><div class="k" id="powerW">—</div><div class="muted">Power (W)</div></div>
          <div class="stat"><div class="k" id="effPct">—</div><div class="muted">Efficiency</div></div>
          <div class="stat"><div class="k" id="co2e">—</div><div class="muted">CO₂e / panel</div></div>
        </div>
        
        <div class="card" style="margin-top:14px">
          <div class="tabs" style="margin-bottom:8px">
            <button id="btnMat"  class="pill active">Material</button>
            <button id="btnChem" class="pill">Chemical</button>
            <button id="btnValue" class="pill">Value</button>
          </div>
        
          <!-- NEW: sized wrapper -->
          <div class="chartBox">
            <canvas id="compositionChart"></canvas>
          </div>
        
          <div class="muted" style="margin-top:6px" id="compLabel">Material composition</div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:28px">
      <!-- LEFT column -->
      <div class="card">
        <h3>General</h3>
        <table id="generalTable"></table>
    
        <h3 id="materials">Composition & Materials</h3>
        <table id="materialsTable"></table>
    
        <h3 id="gcTitle">General composition</h3>
        <div id="extraCats"></div>
    
        <h3>Instructions & Documents</h3>
        <table id="docsTable"></table>
    
        <h3>Updates & Maintenance Log</h3>
        <ul id="updatesList" class="muted" style="padding-left:18px"></ul>
      </div>
    
      <!-- RIGHT column: stack cards here -->
      <div class="rightcol">
        <aside class="card">
          <h3>Passport Info</h3>
          <table>
            <tr><th>UID</th><td id="pi_uid">—</td></tr>
            <tr><th>Country of Origin</th><td id="pi_origin">—</td></tr>
            <tr><th>Compliance</th><td id="pi_compliance">—</td></tr>
            <tr><th>Hazardous Substances</th><td id="pi_haz">—</td></tr>
            <tr><th>Recycled Content</th><td id="pi_recycled">—</td></tr>
            <tr><th>Recyclability</th><td id="pi_recyclability">—</td></tr>
          </table>
          <!-- Circularity bars will be appended here -->
        </aside>
    
        <!-- ONE Component Explorer only -->
        <div id="specExplorer" class="card"></div>
    
        <!-- Mechanical properties explorer -->
        <div id="mechExplorer" class="card"></div>
      </div>
    </section>

    
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const setText = (sel, v)=> { const el=$(sel); if(el) el.textContent = (v??'—'); };

    function table(kv){
      return Object.entries(kv).map(([k,v])=>`<tr><th>${k}</th><td>${format(v)}</td></tr>`).join('');
    }
    function format(v){
      if(v==null || v==='') return '—';
      if(Array.isArray(v)) return v.map(format).join('<br>');
      if(typeof v==='object') return Object.entries(v).map(([k,val])=>`<div><span class="badge">${k}</span> ${format(val)}</div>`).join('');
      if(/^https?:\/\//.test(String(v))) return `<a href="${v}" target="_blank" rel="noopener">Open</a>`;
      return String(v);
    }
    function pctToNumber(x){
      if(x==null) return null;
      if(typeof x==='number') return x;
      const m = String(x).match(/[-+]?[0-9]*\.?[0-9]+/);
      return m ? parseFloat(m[0]) : null;
    }

    function renderCircularity(data){
      const side = document.querySelector('aside.card');
      if(!side) return;
      const wrap = document.createElement('div');
      wrap.innerHTML = `<h3>Circularity</h3><div class="bars" id="circBars"></div>`;
      side.appendChild(wrap);
      
      const bars = wrap.querySelector('#circBars');
      
      const recyc = pctToNumber(data.recyclability);
      if(recyc!=null){
        const row = document.createElement('div');
        row.innerHTML = `<div class="muted" style="margin:4px 0 6px">Recyclability</div><div class="bar"><div class="fill" style="width:${recyc}%;"></div></div>`;
        bars.appendChild(row);
      }

        // Recycled content — only show if > 0
        const rc = data.recycled_content || {};
        for (const [k, v] of Object.entries(rc)) {
          const p = pctToNumber(v);
          if (p == null || p <= 0) continue;  // <-- ignore zero/empty
          const row = document.createElement('div');
          row.innerHTML = `
            <div class="muted" style="margin:8px 0 6px">${k} (recycled)</div>
            <div class="bar"><div class="fill" style="width:${p}%;"></div></div>`;
          bars.appendChild(row);
        }
      }

    // ---- Color helpers (distinct + stable) ----
    const BASE_PALETTE = [
      "#22c55e","#3b82f6","#f59e0b","#ef4444","#a855f7",
      "#06b6d4","#10b981","#f472b6","#eab308","#8b5cf6","#14b8a6","#f97316"
    ];
    
    const MATERIAL_MAP = {
      "glass":"#00d18f",
      "solar cells":"#6f7dff",
      "frame":"#f6c760",
      "edge seal":"#f472b6",
      "junction box":"#1d4ed8",
      "tabbing wire":"#9333ea",
      "busbar wire":"#f59e0b"
    };
    
    const CHEMICAL_MAP = {
      "copper (cu)":"#ef4444",
      "phosphorus (po)":"#a855f7",
      "silicon (si)":"#22c55e",
      "lead (pb)":"#06b6d4"
    };
    
    function norm(s){ return String(s||"").toLowerCase().trim(); }
    function hueFromString(str){
      let h = 0; for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
      return h % 360;
    }
    function colorFromHash(label){ return `hsl(${hueFromString(label)} 70% 55%)`; }
    function hexToHue(hex){
      const m = hex.replace('#','');
      const r = parseInt(m.slice(0,2),16)/255, g = parseInt(m.slice(2,4),16)/255, b = parseInt(m.slice(4,6),16)/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
      if (!d) return 0;
      let h; switch(max){ case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d + 2; break; default: h=(r-g)/d + 4; }
      return Math.round(h*60);
    }
    function pickColors(labels, kind){
      const map = (kind === "chemical") ? CHEMICAL_MAP : MATERIAL_MAP;
      const usedHues = []; const minSep = 18;
      return labels.map(label => {
        const key = norm(label);
        let col = map[key];
        if (!col){
          const start = hueFromString(key) % BASE_PALETTE.length;
          for (let k=0;k<BASE_PALETTE.length;k++){
            const cand = BASE_PALETTE[(start+k)%BASE_PALETTE.length];
            const h = hexToHue(cand);
            if (usedHues.every(u => Math.abs(h-u) >= minSep)){ col = cand; break; }
          }
        }
        if (!col) col = colorFromHash(key);
        usedHues.push(hexToHue(col));
        return col;
      });
    }

    // Parse money strings like "€120.00" -> 120 (prefer numbers in JSON if possible)
    function moneyToNumber(v){
      if (typeof v === 'number') return v;
      if (v == null) return null;
      const s = String(v).trim();
      // keep digits, dot and comma; drop currency symbols/spaces
      let t = s.replace(/[^0-9.,-]/g, '');
      // if both , and . exist, assume . is decimal and remove thousands commas
      if (t.includes('.') && t.includes(',')) t = t.replace(/,/g, '');
      else t = t.replace(',', '.');
      const n = parseFloat(t);
      return Number.isFinite(n) ? n : null;
    }
    
    // Build a value breakdown (percentages + raw €)
    function toValuePercentages(obj){
      const rows = Object.entries(obj || {})
        .map(([k,v]) => [k, moneyToNumber(v)])
        .filter(([,n]) => n != null && n > 0);
      const total = rows.reduce((s,[,n]) => s+n, 0);
      if (!total) return null;
      const labels = rows.map(([k]) => k);
      const raw    = rows.map(([,n]) => n);
      const values = raw.map(n => (n / total) * 100);
      return { labels, values, raw, total };
    }

    function buildCompositionChart(ctx, comp, opts = {}){
      if (!ctx || !comp || !Object.keys(comp).length) return null;
      const labels = Object.keys(comp);
      const values = Object.values(comp).map(v => pctToNumber(v));
      if (values.some(v => v == null)) return null;
    
      const colors = pickColors(labels, opts.kind || "material");
    
      // theme-aware border (falls back if CSS vars missing)
      const css = getComputedStyle(document.documentElement);
      const arcBorder =
        (css.getPropertyValue('--line') || css.getPropertyValue('--bg1') || '#0a1024').trim();
      const textColor = (css.getPropertyValue('--text') || '#cdd6f4').trim();
    
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderColor: arcBorder,   // darker outline
            borderWidth: 2.5,
            spacing: 2,               // tiny gap between slices (Chart.js v4)
            hoverBorderWidth: 3,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '68%',
          layout: { padding: 8 },
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: textColor, usePointStyle: true, pointStyle: 'rectRounded', boxWidth: 10 }
            },
            tooltip: {
              callbacks: {
                // If you're showing € values, switch this to your money formatter
                label: (tt) => `${tt.label}: ${tt.formattedValue}`
              }
            }
          }
        }
      });
    }


    /* NEW: Component Explorer */

      function buildExplorer(data){
        const root = document.getElementById('specExplorer');
        const comps = (data.components || []).map(c => c.name);
        if (!root || !comps.length) { if(root) root.style.display='none'; return; }

        // Remember the last-selected category (per component + global fallback)
        let currentComp = comps[0];
        const compMap = {}; (data.components||[]).forEach(c => compMap[c.name] = c);
        const catByComp = {};   // e.g., { "Solar cells": "Sourcing composition" }
        let globalCat = null;   // last picked category, used as a fallback

        root.innerHTML = `
          <h3>Component Explorer</h3>
          <div class="toolbar">
            <label class="muted">Component</label>
            <select id="compSel" class="select"></select>
          </div>
          <div id="catTabs" class="tabs"></div>
          <div id="catPane" class="accordion"></div>
        `;

        const sel = root.querySelector('#compSel');
        comps.forEach(n => { const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o); });
        sel.addEventListener('change', () => { currentComp = sel.value; renderTabs(); });

        function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
      
        function renderRow(f){
          const isBool = f?.datatype === 'boolean' || typeof f?.value === 'boolean' ||
                         /^(yes|no)$/i.test(String(f?.value ?? ''));
          const label = escapeHtml(f.label || '');
          const tip   = f.description ? `<span title="${escapeHtml(f.description)}" style="margin-left:6px;color:#9fb1d9">ℹ️</span>` : '';
        
          let valueHtml, unitHtml = '';
          if (isBool) {
            const present = (typeof f.value === 'boolean') ? f.value : /^yes$/i.test(String(f.value));
            valueHtml = `<span class="tag ${present ? 'yes' : 'no'}">${present ? 'Yes' : 'No'}</span>`;
          } else {
            const val = (f.value === '' || f.value == null) ? '—' : escapeHtml(f.value);
            valueHtml = val;
            unitHtml  = f.unit ? ` <span class="muted">${escapeHtml(f.unit)}</span>` : '';
          }
        
          const files = (f.files||[]).map(u => `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">file</a>`).join(' · ');
          const extra = [
            files && `Files: ${files}`,
            f.comments && `Comments: ${escapeHtml(f.comments)}`,
            f.note && `Note: ${escapeHtml(f.note)}`
          ].filter(Boolean).join('<br>');
        
          return `<tr>
            <th style="text-align:left;padding:8px 6px;color:#9fb1d9;width:38%">${label}${tip}</th>
            <td style="padding:8px 6px">${valueHtml}${unitHtml}${extra ? `<div class="muted" style="margin-top:6px">${extra}</div>`:''}</td>
          </tr>`;
        }

        function renderFields(comp, catName){
          const groups = comp.categories[catName] || {};
          const pane = root.querySelector('#catPane');
          pane.innerHTML = '';
          Object.keys(groups).forEach(groupName => {
            const group = groups[groupName] || [];
            const box = document.createElement('details');
            box.open = true;
            box.innerHTML = `
              <summary><h4 style="display:inline">${escapeHtml(groupName === '—' ? 'Details' : groupName)}</h4></summary>
              <table style="width:100%;border-collapse:collapse;margin-top:6px">
                ${group.map(renderRow).join('')}
              </table>
            `;
            pane.appendChild(box);
          });
        }

        function renderTabs(){
          const comp = compMap[currentComp]; if(!comp) return;
          const cats = Object.keys(comp.categories||{});
          const tabs = root.querySelector('#catTabs');
          tabs.innerHTML = '';
      
          // Prefer the last-used category if present; else global; else first
          const preferred = catByComp[currentComp] || globalCat;
          const active = (preferred && cats.includes(preferred)) ? preferred : cats[0];
      
          cats.forEach(cn => {
            const b = document.createElement('button');
            b.textContent = cn; b.className = 'pill';
            b.onclick = ()=> {
              [...tabs.children].forEach(x=>x.classList.remove('active'));
              b.classList.add('active');
              catByComp[currentComp] = cn;  // remember for this component
              globalCat = cn;               // remember globally too
              renderFields(comp, cn);
            };
            tabs.appendChild(b);
          });

          // Activate the right tab and render fields
          const btnToActivate = [...tabs.children].find(x => x.textContent === active) || tabs.firstChild;
          if (btnToActivate) {
            btnToActivate.classList.add('active');
            renderFields(comp, btnToActivate.textContent);
          }
        }
      
        renderTabs();
      }

    // Render extra (non-explorer) categories from data.extra_categories

    function renderExtraCategories(data, { only = null } = {}){
      const container = document.getElementById('extraCats');
      if (!container) return;
    
      const extra = data.extra_categories || {};
      const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    
      function rowHtml(f){
        const label = esc(f.label || '');
        const val   = (f.value === '' || f.value == null) ? '—' : esc(f.value);
        const unit  = f.unit ? ` <span class="muted">${esc(f.unit)}</span>` : '';
        const tip   = f.description ? `<span title="${esc(f.description)}" style="margin-left:6px;color:#9fb1d9">ℹ️</span>` : '';
        const files = (f.files||[]).map(u => `<a href="${esc(u)}" target="_blank" rel="noopener">file</a>`).join(' · ');
        const extras = [files && `Files: ${files}`, f.comments && `Comments: ${esc(f.comments)}`, f.note && `Note: ${esc(f.note)}`]
                        .filter(Boolean).join('<br>');
        return `<tr>
          <th style="text-align:left;padding:8px 6px;color:#9fb1d9;width:38%">${label}${tip}</th>
          <td style="padding:8px 6px">${val}${unit}${extras ? `<div class="muted" style="margin-top:6px">${extras}</div>`:''}</td>
        </tr>`;
      }
    
      // pick only the requested category
      let catNames = Object.keys(extra);
      if (only) catNames = catNames.filter(n => n === only);
      if (!catNames.length){
        container.innerHTML = `<div class="muted">No additional categories yet.</div>`;
        return;
      }
    
      container.innerHTML = catNames.map(catName => {
        const byComponent = extra[catName] || {};
        const compBlocks = Object.keys(byComponent).map(compName => {
          const groups = byComponent[compName] || {};
          const groupHtml = Object.keys(groups).map(groupName => {
            const fields = groups[groupName] || [];
            const title = esc(groupName === '—' ? 'Details' : groupName);
            return `<details open>
              <summary><b>${title}</b></summary>
              <table style="width:100%;border-collapse:collapse;margin-top:6px">
                ${fields.map(rowHtml).join('')}
              </table>
            </details>`;
          }).join('');
          return `<div class="card" style="margin-top:10px">
            <div class="pill" style="margin-bottom:8px">${esc(compName)}</div>
            ${groupHtml || `<div class="muted">No data.</div>`}
          </div>`;
        }).join('');
    
        // We already show an outer H3 “General composition”, so hide per-category H4s with your CSS
        return `<h4 style="margin:12px 0 6px">${esc(catName)}</h4>${compBlocks || `<div class="muted">No data.</div>`}`;
      }).join('');
    }


    
    (async function(){
      const params = new URLSearchParams(location.search);
      const serial = (params.get('serial')||'KS2508P01003').toUpperCase();
      setText('#serialBadge', `Serial: ${serial}`);

      const jsonUrl = new URL(`passports/${encodeURIComponent(serial)}.json`, document.baseURI);
      let data;
      try{
        const res = await fetch(jsonUrl, { cache:'no-store' });
        if(!res.ok) throw new Error(`Missing JSON for ${serial}`);
        data = await res.json();
      }catch(err){
        $('#generalTable').innerHTML = `<tr><td><em>Error loading JSON:</em> ${String(err.message||err)}</td></tr>`;
        console.error('DPP load error', err);
        return;
      }

      // Right-column explorer for Mechanical + Use + EoL
      function buildMechanicalExplorer(data){
        const root  = document.getElementById('mechExplorer');
        const extra = data.extra_categories || {};
        if (!root) return;
      
        // Only show these categories in this card
        const ALLOWED = ["Mechanical properties", "Use", "End of life (EoL)", "Sorting", "Regulations", "Environment"];
        let catNames = Object.keys(extra).filter(n => ALLOWED.includes(n));
        if (!catNames.length){ root.style.display = 'none'; return; }

        root.innerHTML = `
          <h3 style="margin-top:0">Mechanical properties</h3>
          <div id="meTabs" class="tabs"></div>
          <div class="toolbar">
            <label class="muted">Component</label>
            <select id="meComp" class="select"></select>
          </div>
          <div id="mePane"></div>
        `;
      
        const esc  = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        const tabs = root.querySelector('#meTabs');
        const sel  = root.querySelector('#meComp');
        const pane = root.querySelector('#mePane');
      
        // Default tab = Mechanical properties if present
        let currentCat  = catNames.includes("Mechanical properties") ? "Mechanical properties" : catNames[0];
        let currentComp = null;
      
        function listComps(cat){ return Object.keys(extra[cat] || {}); }
      
        function row(f){
          const files = (f.files||[]).map(u => `<a href="${esc(u)}" target="_blank" rel="noopener">file</a>`).join(' · ');
          const extraTxt = [files && `Files: ${files}`, f.comments && `Comments: ${esc(f.comments)}`, f.note && `Note: ${esc(f.note)}`]
            .filter(Boolean).join('<br>');
      
          if (f.datatype === 'boolean'){
            const yes = !!f.value;
            return `<tr>
              <th style="text-align:left;padding:8px 6px;color:#9fb1d9;width:38%">${esc(f.label||'')}</th>
              <td style="padding:8px 6px"><span class="badge bool ${yes?'yes':'no'}">${yes?'Yes':'No'}</span>${extraTxt?`<div class="muted" style="margin-top:6px">${extraTxt}</div>`:''}</td>
            </tr>`;
          }
      
          const label = esc(f.label || '');
          const val   = (f.value === '' || f.value == null) ? '—' : esc(f.value);
          const unit  = f.unit ? ` <span class="muted">${esc(f.unit)}</span>` : '';
          const tip   = f.description ? `<span title="${esc(f.description)}" style="margin-left:6px;color:#9fb1d9">ℹ️</span>` : '';
          return `<tr>
            <th style="text-align:left;padding:8px 6px;color:#9fb1d9;width:38%">${label}${tip}</th>
            <td style="padding:8px 6px">${val}${unit}${extraTxt?`<div class="muted" style="margin-top:6px">${extraTxt}</div>`:''}</td>
          </tr>`;
        }
        
        function normalizeFields(groupVal){
          // Expect an array of fields; if it's a single object -> wrap; if bad -> empty array
          if (Array.isArray(groupVal)) return groupVal;
          if (groupVal && typeof groupVal === 'object') return [groupVal];
          return [];
        }
    
        function render(){
          const catObj   = extra[currentCat] || {};
          const compObj  = catObj[currentComp] || {};
          const groupIds = Object.keys(compObj);
    
          pane.innerHTML = '';
    
          if (!groupIds.length){
            pane.innerHTML = `<div class="muted">No data for <b>${esc(currentComp||'—')}</b> in <b>${esc(currentCat)}</b>.</div>`;
            return;
          }
    
          groupIds.forEach(groupName => {
            const fields = normalizeFields(compObj[groupName]);
            const det = document.createElement('details');
            det.open = true;
            det.innerHTML = `
              <summary><b>${esc(groupName === '—' ? 'Details' : groupName)}</b></summary>
              ${
                fields.length
                  ? `<table style="width:100%;border-collapse:collapse;margin-top:6px">
                       ${fields.map(row).join('')}
                     </table>`
                  : `<div class="muted" style="margin-top:6px">No fields in this group.</div>`
              }
            `;
            pane.appendChild(det);
          });
        }

      
        function fillComp(){
          const comps = listComps(currentCat);
          sel.innerHTML = '';
          comps.forEach(n => { const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o); });
          currentComp = comps[0];
        }
      
        function fillTabs(){
          tabs.innerHTML = '';
          catNames.forEach(name => {
            const b = document.createElement('button');
            b.className = 'pill'; b.textContent = name;
            b.onclick = () => {
              currentCat = name;
              [...tabs.children].forEach(x => x.classList.remove('active'));
              b.classList.add('active');
              fillComp(); render();
            };
            tabs.appendChild(b);
          });
          // activate default tab
          ([...tabs.children].find(x => x.textContent === currentCat) || tabs.firstChild)?.classList.add('active');
        }
      
        sel.addEventListener('change', () => { currentComp = sel.value; render(); });
      
        fillTabs();
        fillComp();
        render();
      }


      // Header bits
      setText('#modelTitle', data.model || '—');
      setText('#countryYear', `${data.origin||'—'} • ${ (data.manufacture_date||'—').toString().slice(0,4) }`);
      setText('#powerW', data.power_w!=null ? data.power_w : '—');
      setText('#effPct', data.efficiency_pct!=null ? `${data.efficiency_pct}%` : '—');
      setText('#co2e', data.co2e_kg!=null ? `${data.co2e_kg} kg` : '—');

      // UID & buttons
      setText('#uid', data.uid || `urn:bs:pv:${serial}`);
      $('#openDatasheet').href = data.safety_datasheet_url || '#';

      // General table
      $('#generalTable').innerHTML = table({
        Model: data.model,
        Manufacturer: data.manufacturer,
        'Manufacture Date': data.manufacture_date,
        'Power Rating (W)': data.power_w,
        'Cell Type': data.cell_type,
        'Dimensions (mm)': data.dimensions_mm,
        'Weight (kg)': data.weight_kg,
        'Efficiency (%)': data.efficiency_pct,
        'CO₂ eq per panel (kg)': data.co2e_kg,
        'Lifetime (years)': data.lifetime_years,
        'Warranty (years)': data.warranty_years,
        'Certifications': data.certifications,
      });

      // Materials
      $('#materialsTable').innerHTML = table(data.materials || {});

      // Docs
      $('#docsTable').innerHTML = table({
        'Safety Datasheet': data.safety_datasheet_url,
        'ESG Statement': data.esg_statement_url,
        'LCA report': data.lca_report_url,
        'EPD (Environmental Product Declaration)': data.epd_url,
      });

      // Updates
      const updates = Array.isArray(data.updates) ? data.updates : [];
      $('#updatesList').innerHTML = updates.length ? updates.map(u=>`<li>${format(u)}</li>`).join('') : '<li>No updates yet.</li>';

      // Sidebar passport info
      setText('#pi_uid', data.uid || serial);
      setText('#pi_hs', data.hs_code || '—');
      setText('#pi_origin', data.origin || '—');
      setText('#pi_compliance', Array.isArray(data.compliance)? data.compliance.join(', ') : (data.compliance||'—'));
      setText('#pi_haz', Array.isArray(data.hazardous_substances)? data.hazardous_substances.join(', ') : (data.hazardous_substances||'—'));
      const rc = data.recycled_content || {};
      const rcEntries = Object.entries(rc).filter(([_, v]) => {
        const p = pctToNumber(v);
        return p != null && p > 0;   // keep only positive values
      });
      const rcText = rcEntries.length
        ? rcEntries.map(([k, v]) => `${k}: ${v}`).join(', ')
        : '—'; // show dash when none
      setText('#pi_recycled', rcText);
      setText('#pi_recyclability', data.recyclability || '—');

      // Circularity bars
      renderCircularity(data);

      // Composition chart

      const mat = data.material_composition_pct || null;
      const chem = data.chemical_composition_pct || null;
      const canvas = document.getElementById('compositionChart');
      const labelEl = document.getElementById('compLabel');
      const btnMat = document.getElementById('btnMat');
      const btnChem = document.getElementById('btnChem');
      const price = data.cost_breakdown_eur || null;
      const btnValue = document.getElementById('btnValue');

      
      let donut;

      function show(dataset, label, kind='material'){
        if (!canvas) return;
        if (donut) donut.destroy();
        donut = buildCompositionChart(canvas, dataset, { kind });
        labelEl.textContent = label;
        canvas.parentElement.style.display = donut ? '' : 'none';
      }
      
      btnMat.addEventListener('click', ()=>{
        btnMat.classList.add('active'); btnChem.classList.remove('active'); btnValue.classList.remove('active');
        show(mat, 'Material composition (%)', 'material');
      });
      btnChem.addEventListener('click', ()=>{
        btnChem.classList.add('active'); btnMat.classList.remove('active'); btnValue.classList.remove('active');
        show(chem, 'Chemical composition (%)', 'chemical');
      });
      btnValue.addEventListener('click', ()=>{
        btnValue.classList.add('active'); btnMat.classList.remove('active'); btnChem.classList.remove('active');
        show(price, 'Value breakdown (by price, €)', 'value');
      });
      
      // initial render preference: Value if present, else Material, else Chemical
      if (price){
        btnValue.classList.add('active'); show(price, 'Value breakdown (by price, €)', 'value');
      } else if (mat){
        btnMat.classList.add('active');   show(mat, 'Material composition (%)', 'material');
      } else if (chem){
        btnChem.classList.add('active');  show(chem, 'Chemical composition (%)', 'chemical');
      } else {
        canvas.parentElement.style.display = 'none';
      }


      // NEW: Explorer
      buildExplorer(data);
      buildMechanicalExplorer(data);
      renderExtraCategories(data, { only: "General composition" });
    })();


    (() => {
      const btn  = document.getElementById('themeToggle');
      if (!btn) return;

      const root = document.documentElement;

      // Load saved theme or user OS preference as a fallback
      const saved = localStorage.getItem('theme');
      if (saved !== null) {
        root.dataset.theme = saved;              // '' or 'light'
      } else if (window.matchMedia &&
                 window.matchMedia('(prefers-color-scheme: light)').matches) {
        root.dataset.theme = 'light';
      }

      // Optional label text; using emoji by default
      // btn.textContent = (root.dataset.theme === 'light') ? 'Dark' : 'Light';

      btn.addEventListener('click', () => {
        const next = root.dataset.theme === 'light' ? '' : 'light';
        root.dataset.theme = next;
        localStorage.setItem('theme', next);
        // btn.textContent = (next === 'light') ? 'Dark' : 'Light';
      });
    })();
  </script>
</body>
</html>
